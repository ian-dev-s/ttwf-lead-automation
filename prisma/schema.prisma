// Prisma schema for TTWF Lead Generator
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// User roles for access control
enum UserRole {
  ADMIN
  USER
  VIEWER
}

// Lead statuses for Kanban tracking
enum LeadStatus {
  NEW
  QUALIFIED
  MESSAGE_READY
  PENDING_APPROVAL
  CONTACTED
  RESPONDED
  CONVERTED
  NOT_INTERESTED
  REJECTED
  INVALID
}

// Message types
enum MessageType {
  WHATSAPP
  EMAIL
}

// Message status
enum MessageStatus {
  DRAFT
  PENDING_APPROVAL
  APPROVED
  SENT
  FAILED
}

// AI Provider options
enum AIProvider {
  OPENAI
  ANTHROPIC
  GOOGLE
  GITHUB
  CURSOR
}

// Scraping job status
enum JobStatus {
  SCHEDULED
  RUNNING
  COMPLETED
  FAILED
  CANCELLED
}

// ============================================================
// Team / Multi-tenancy
// ============================================================

// Team model - the core tenant entity
model Team {
  id        String   @id @default(cuid())
  name      String
  slug      String   @unique
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  users              User[]
  settings           TeamSettings?
  apiKeys            TeamApiKey[]
  leads              Lead[]
  messages           Message[]
  inboundEmails      InboundEmail[]
  emailTemplates     EmailTemplate[]
  aiKnowledgeItems   AIKnowledgeItem[]
  aiSampleResponses  AISampleResponse[]
  scrapingJobs       ScrapingJob[]
  contacts           Contact[]
  aiConfigs          AIConfig[]
  analyzedBusinesses AnalyzedBusiness[]
  statusHistory      StatusHistory[]

  @@map("teams")
}

// Per-team settings (replaces SystemSettings)
model TeamSettings {
  id     String @id @default(cuid())
  teamId String @unique @map("team_id")

  // Lead generation settings
  dailyLeadTarget       Int      @default(10) @map("daily_lead_target")
  leadGenerationEnabled Boolean  @default(true) @map("lead_generation_enabled")

  // Scraping settings
  scrapeDelayMs         Int      @default(2000) @map("scrape_delay_ms")
  maxLeadsPerRun        Int      @default(20) @map("max_leads_per_run")
  searchRadiusKm        Int      @default(50) @map("search_radius_km")
  minGoogleRating       Float    @default(4.0) @map("min_google_rating")

  // Industry settings
  targetIndustries      String[] @map("target_industries")
  blacklistedIndustries String[] @map("blacklisted_industries")

  // Location settings
  targetCities          String[] @map("target_cities")

  // Message settings
  autoGenerateMessages  Boolean  @default(true) @map("auto_generate_messages")

  // Branding settings
  companyName        String   @default("My Company") @map("company_name")
  companyWebsite     String   @default("https://example.com") @map("company_website")
  companyTagline     String   @default("") @map("company_tagline")
  logoUrl            String?  @map("logo_url")
  bannerUrl          String?  @map("banner_url")
  whatsappPhone      String?  @map("whatsapp_phone")
  socialFacebookUrl  String?  @map("social_facebook_url")
  socialInstagramUrl String?  @map("social_instagram_url")
  socialLinkedinUrl  String?  @map("social_linkedin_url")
  socialTwitterUrl   String?  @map("social_twitter_url")
  socialTiktokUrl    String?  @map("social_tiktok_url")

  // AI Training settings
  aiTone               String?  @map("ai_tone")
  aiWritingStyle       String?  @map("ai_writing_style")
  aiCustomInstructions String?  @db.Text @map("ai_custom_instructions")

  // SMTP config (user/pass are encrypted with AES-256-GCM)
  smtpHost          String?  @map("smtp_host")
  smtpPort          Int      @default(587) @map("smtp_port")
  smtpSecure        Boolean  @default(false) @map("smtp_secure")
  smtpUser          String?  @map("smtp_user")       // AES-256-GCM encrypted
  smtpPass          String?  @map("smtp_pass")       // AES-256-GCM encrypted
  emailFrom         String?  @map("email_from")
  emailDebugMode    Boolean  @default(false) @map("email_debug_mode")
  emailDebugAddress String?  @map("email_debug_address")

  // IMAP config (user/pass are encrypted with AES-256-GCM)
  imapHost          String?  @map("imap_host")
  imapPort          Int      @default(993) @map("imap_port")
  imapSecure        Boolean  @default(true) @map("imap_secure")
  imapUser          String?  @map("imap_user")       // AES-256-GCM encrypted
  imapPass          String?  @map("imap_pass")       // AES-256-GCM encrypted

  // Tracking
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  team Team @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@map("team_settings")
}

// Per-team API keys for AI providers (encrypted)
model TeamApiKey {
  id           String   @id @default(cuid())
  teamId       String   @map("team_id")
  provider     String                        // e.g., "OPENROUTER", "OPENAI"
  encryptedKey String   @map("encrypted_key") // AES-256-GCM encrypted API key
  label        String?                        // user-friendly label
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Relations
  team Team @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@unique([teamId, provider])
  @@index([teamId])
  @@map("team_api_keys")
}

// ============================================================
// Auth models
// ============================================================

// User model for authentication and access control
model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String?
  passwordHash  String    @map("password_hash")
  role          UserRole  @default(USER)
  emailVerified DateTime? @map("email_verified")
  image         String?
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  // Team membership
  teamId        String?   @map("team_id")
  team          Team?     @relation(fields: [teamId], references: [id])

  // Relations
  leads          Lead[]
  statusChanges  StatusHistory[]
  sessions       Session[]
  accounts       Account[]
  contacts       Contact[]

  @@index([teamId])
  @@map("users")
}

// NextAuth Account model
model Account {
  id                String  @id @default(cuid())
  userId            String  @map("user_id")
  type              String
  provider          String
  providerAccountId String  @map("provider_account_id")
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

// NextAuth Session model
model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique @map("session_token")
  userId       String   @map("user_id")
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

// NextAuth Verification Token
model VerificationToken {
  identifier String
  token      String
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

// ============================================================
// Business data models (all team-scoped)
// ============================================================

// Lead model - the core business entity
model Lead {
  id             String     @id @default(cuid())
  teamId         String     @map("team_id")
  businessName   String     @map("business_name")
  industry       String?
  location       String
  country        String     @default("ZA")
  address        String?
  phone          String?
  email          String?
  facebookUrl    String?    @map("facebook_url")
  instagramUrl   String?    @map("instagram_url")
  twitterUrl     String?    @map("twitter_url")
  linkedinUrl    String?    @map("linkedin_url")
  googleMapsUrl  String?    @map("google_maps_url")
  website        String?
  websiteQuality Int?       @map("website_quality")
  googleRating   Float?     @map("google_rating")
  reviewCount    Int?       @map("review_count")
  description    String?    @db.Text
  status         LeadStatus @default(NEW)
  source         String?
  score          Int        @default(0)
  notes          String?    @db.Text
  metadata       Json?

  // Tracking
  createdAt      DateTime   @default(now()) @map("created_at")
  updatedAt      DateTime   @updatedAt @map("updated_at")
  contactedAt    DateTime?  @map("contacted_at")

  // Relations
  createdById    String?    @map("created_by_id")
  createdBy      User?      @relation(fields: [createdById], references: [id])
  team           Team       @relation(fields: [teamId], references: [id], onDelete: Cascade)
  messages       Message[]
  statusHistory  StatusHistory[]
  inboundEmails  InboundEmail[]

  @@index([teamId])
  @@index([status])
  @@index([createdAt])
  @@index([score])
  @@index([country])
  @@map("leads")
}

// Message model - for personalized outreach
model Message {
  id          String        @id @default(cuid())
  teamId      String        @map("team_id")
  leadId      String        @map("lead_id")
  type        MessageType
  subject     String?
  content     String        @db.Text
  status      MessageStatus @default(DRAFT)
  sentAt      DateTime?     @map("sent_at")
  error       String?

  // AI Generation tracking
  generatedBy String?       @map("generated_by")
  aiProvider  String?       @map("ai_provider")
  aiModel     String?       @map("ai_model")

  // Tracking
  createdAt   DateTime      @default(now()) @map("created_at")
  updatedAt   DateTime      @updatedAt @map("updated_at")

  // Relations
  team        Team          @relation(fields: [teamId], references: [id], onDelete: Cascade)
  lead        Lead          @relation(fields: [leadId], references: [id], onDelete: Cascade)

  @@index([teamId])
  @@index([leadId])
  @@index([status])
  @@map("messages")
}

// Status history for tracking lead progression
model StatusHistory {
  id          String     @id @default(cuid())
  teamId      String     @map("team_id")
  leadId      String     @map("lead_id")
  fromStatus  LeadStatus @map("from_status")
  toStatus    LeadStatus @map("to_status")
  changedById String?    @map("changed_by_id")
  changedAt   DateTime   @default(now()) @map("changed_at")
  notes       String?

  // Relations
  team        Team       @relation(fields: [teamId], references: [id], onDelete: Cascade)
  lead        Lead       @relation(fields: [leadId], references: [id], onDelete: Cascade)
  changedBy   User?      @relation(fields: [changedById], references: [id])

  @@index([teamId])
  @@index([leadId])
  @@map("status_history")
}

// AI Configuration for flexible provider switching
model AIConfig {
  id          String     @id @default(cuid())
  teamId      String     @map("team_id")
  name        String
  provider    AIProvider
  model       String
  isActive    Boolean    @default(false) @map("is_active")

  // Guardrails configuration
  temperature    Float    @default(0.7)
  maxTokens      Int      @default(1000) @map("max_tokens")
  systemPrompt   String?  @db.Text @map("system_prompt")

  // Rate limiting
  requestsPerDay Int      @default(100) @map("requests_per_day")
  requestsUsed   Int      @default(0) @map("requests_used")
  lastResetAt    DateTime @default(now()) @map("last_reset_at")

  // Tracking
  createdAt   DateTime   @default(now()) @map("created_at")
  updatedAt   DateTime   @updatedAt @map("updated_at")

  // Relations
  team        Team       @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@index([teamId])
  @@map("ai_configs")
}

// Scraping job configuration and tracking
model ScrapingJob {
  id             String    @id @default(cuid())
  teamId         String    @map("team_id")
  status         JobStatus @default(SCHEDULED)
  leadsRequested Int       @map("leads_requested")
  leadsFound     Int       @default(0) @map("leads_found")

  // Search parameters
  searchQuery    String?   @map("search_query")
  categories     String[]
  locations      String[]
  country        String    @default("ZA")
  minRating      Float?    @map("min_rating")
  maxRadius      Int?      @map("max_radius")

  // Scheduling
  scheduledFor   DateTime  @map("scheduled_for")
  startedAt      DateTime? @map("started_at")
  completedAt    DateTime? @map("completed_at")

  // Error handling
  error          String?

  // Process tracking
  processPids    String?   @map("process_pids") @db.Text

  // Tracking
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  // Relations
  team           Team      @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@index([teamId])
  @@index([status])
  @@index([scheduledFor])
  @@map("scraping_jobs")
}

// Analyzed Business History
model AnalyzedBusiness {
  id              String   @id @default(cuid())
  teamId          String   @map("team_id")

  // Business identification
  businessName    String   @map("business_name")
  location        String
  country         String   @default("ZA")
  googleMapsUrl   String?  @unique @map("google_maps_url")

  // Contact details found
  phone           String?
  website         String?
  address         String?

  // Google Maps data
  googleRating    Float?   @map("google_rating")
  reviewCount     Int?     @map("review_count")
  category        String?

  // Analysis results
  websiteQuality  Int?     @map("website_quality")
  isGoodProspect  Boolean  @map("is_good_prospect")
  skipReason      String?  @map("skip_reason")

  // Status tracking
  wasConverted    Boolean  @default(false) @map("was_converted")
  leadId          String?  @map("lead_id")

  // Timestamps
  analyzedAt      DateTime @default(now()) @map("analyzed_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  // Relations
  team            Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@index([teamId])
  @@index([businessName, location])
  @@index([isGoodProspect])
  @@index([analyzedAt])
  @@index([country])
  @@map("analyzed_businesses")
}

// Contact for address book
model Contact {
  id          String   @id @default(cuid())
  teamId      String   @map("team_id")
  name        String
  email       String?
  phone       String?
  telegramId  String?  @map("telegram_id")
  notes       String?
  isFavorite  Boolean  @default(false) @map("is_favorite")

  // Timestamps
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  createdById String?  @map("created_by_id")
  createdBy   User?    @relation(fields: [createdById], references: [id])
  team        Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@index([teamId])
  @@index([name])
  @@index([isFavorite])
  @@map("contacts")
}

// ============================================================
// Email & AI models (all team-scoped)
// ============================================================

// Email template for AI guardrails and message generation
model EmailTemplate {
  id            String   @id @default(cuid())
  teamId        String   @map("team_id")
  name          String
  description   String?
  purpose       String   @default("outreach")
  systemPrompt  String   @db.Text @map("system_prompt")
  bodyTemplate  String?  @db.Text @map("body_template")
  subjectLine   String?  @map("subject_line")
  isActive      Boolean  @default(false) @map("is_active")
  isDefault     Boolean  @default(false) @map("is_default")

  // Guardrails
  tone          String?
  maxLength     Int?     @map("max_length")
  mustInclude   String[] @map("must_include")
  avoidTopics   String[] @map("avoid_topics")

  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  // Relations
  team          Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@index([teamId])
  @@index([purpose])
  @@index([isActive])
  @@map("email_templates")
}

// AI Knowledge Base item for training
model AIKnowledgeItem {
  id        String   @id @default(cuid())
  teamId    String   @map("team_id")
  title     String
  content   String   @db.Text
  category  String?
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  team      Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@index([teamId])
  @@index([category])
  @@map("ai_knowledge_items")
}

// AI Sample Response for training
model AISampleResponse {
  id                String   @id @default(cuid())
  teamId            String   @map("team_id")
  customerQuestion  String   @db.Text @map("customer_question")
  preferredResponse String   @db.Text @map("preferred_response")
  category          String?
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  // Relations
  team              Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@index([teamId])
  @@index([category])
  @@map("ai_sample_responses")
}

// Inbound email received via IMAP
model InboundEmail {
  id            String   @id @default(cuid())
  teamId        String   @map("team_id")
  messageId     String   @unique @map("message_id")
  from          String
  to            String
  subject       String
  bodyText      String?  @db.Text @map("body_text")
  bodyHtml      String?  @db.Text @map("body_html")
  receivedAt    DateTime @map("received_at")
  isRead        Boolean  @default(false) @map("is_read")
  isProcessed   Boolean  @default(false) @map("is_processed")

  // Link to lead if matched
  leadId        String?  @map("lead_id")
  lead          Lead?    @relation(fields: [leadId], references: [id])

  // AI-generated reply message ID
  aiReplyId     String?  @map("ai_reply_id")

  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  // Relations
  team          Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@index([teamId])
  @@index([from])
  @@index([leadId])
  @@index([isProcessed])
  @@map("inbound_emails")
}
